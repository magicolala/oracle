<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oracle Analyzer – Résultats</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', path='github-dark.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='oracle-board.css') }}" />
  </head>
  <body class="app-shell">
    <nav class="app-nav navbar navbar-dark">
      <div class="container-xxl px-4 px-lg-5">
        <a class="navbar-brand" href="/">Oracle Analyzer</a>
      </div>
    </nav>
    <main class="app-main">
      <div class="container-xxl px-4 px-lg-5">
        <div class="row g-4 justify-content-center">
          <div class="col-12 col-xl-10 col-xxl-9">
            <div class="card p-4 p-lg-5 mb-4">
              <div class="row g-4 align-items-start">
                <div class="col-lg-7">
                  <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                    <div>
                      <h1 class="h3 mb-2">Résultats de l'analyse</h1>
                      <p class="mb-0 text-secondary">
                        Estimation actuelle :
                        <strong>{{ '%.2f'|format(current_win_percentage) }}%</strong> de chances pour les blancs.
                      </p>
                    </div>
                    <div class="text-end">
                      <a href="/?mode={{ active_mode or 'analyze' }}" class="btn btn-primary">Nouvelle analyse</a>
                    </div>
                  </div>
                  {% if latest %}
                  <dl class="board-summary row g-3 mt-3 mb-0">
                    <dt class="col-sm-5 col-lg-4">Dernier coup joué</dt>
                    <dd class="col-sm-7 col-lg-8">{{ latest.san or 'Début de partie' }}</dd>
                    <dt class="col-sm-5 col-lg-4">Trait</dt>
                    <dd class="col-sm-7 col-lg-8">{{ 'Blancs' if latest.is_white_to_move else 'Noirs' }}</dd>
                  </dl>
                  {% endif %}
                </div>
                <div class="col-lg-5">
                  <div class="board-panel">
                    <p class="board-panel__header mb-1">Plateau interactif</p>
                    <div id="oracle-board"></div>
                    <p class="board-panel__hint mb-0">
                      Le PGN analysé est chargé automatiquement. Jouez un coup pour explorer différentes suites.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="card p-4 p-lg-5 mb-4">
              <h2 class="h5 mb-3">Explorer les coups</h2>
              {% if history %}
              {% set active_index = history|length - 1 %}
              <ul class="nav nav-tabs flex-wrap" id="prediction-tabs" role="tablist">
                {% for snapshot in history %}
                {% set tab_id = 'position-' ~ loop.index0 %}
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link {% if loop.index0 == active_index %}active{% endif %}"
                    id="{{ tab_id }}-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#{{ tab_id }}"
                    type="button"
                    role="tab"
                    aria-controls="{{ tab_id }}"
                    aria-selected="{{ 'true' if loop.index0 == active_index else 'false' }}"
                  >
                    {{ loop.index }}. {{ snapshot.san or 'Début de partie' }}
                  </button>
                </li>
                {% endfor %}
              </ul>
              <div class="tab-content pt-3" id="prediction-tabs-content">
                {% for snapshot in history %}
                {% set tab_id = 'position-' ~ loop.index0 %}
                <div
                  class="tab-pane fade {% if loop.index0 == active_index %}show active{% endif %}"
                  id="{{ tab_id }}"
                  role="tabpanel"
                  aria-labelledby="{{ tab_id }}-tab"
                >
                  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                      <h3 class="h6 mb-1">
                        Trait aux {{ 'blancs' if snapshot.is_white_to_move else 'noirs' }}
                      </h3>
                      <p class="mb-0 text-secondary">
                        PGN : {{ snapshot.san or 'Début de partie' }}
                      </p>
                    </div>
                    <span class="badge bg-secondary">#{{ loop.index }}</span>
                  </div>
                  <div class="table-responsive mt-3">
                    {% if snapshot.moves %}
                    <table class="table table-hover align-middle">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col">Coup</th>
                          <th scope="col">Probabilité</th>
                          <th scope="col">Évaluation</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for prediction in snapshot.moves %}
                        <tr>
                          <th scope="row">{{ loop.index }}</th>
                          <td>
                            <span class="fw-semibold">{{ prediction.move }}{{ prediction.notation }}</span>
                            {% if prediction.is_best_move %}
                            <span class="badge bg-success ms-2">Meilleur coup</span>
                            {% endif %}
                          </td>
                          <td>{{ '%.2f'|format(prediction.likelihood) }}%</td>
                          <td>
                            <div>{{ '%.2f'|format(prediction.win_percentage) }}%</div>
                            {% if prediction.win_percentage_by_rating %}
                            <details class="mt-1">
                              <summary class="small text-secondary">
                                Évaluations Elo
                              </summary>
                              <ul class="list-unstyled small text-secondary ms-3 mb-0">
                                {% for rating, percentage in prediction.win_percentage_by_rating|dictsort %}
                                <li>
                                  <span class="fw-semibold">Elo {{ rating }}</span>
                                  : {{ '%.2f'|format(percentage) }}%
                                </li>
                                {% endfor %}
                              </ul>
                            </details>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    {% else %}
                    <p class="mb-0 text-secondary">
                      Aucun coup légal disponible pour cette position.
                    </p>
                    {% endif %}
                  </div>
                  <p class="mt-3 mb-0 text-secondary">
                    Évaluation actuelle :
                    <strong>{{ '%.2f'|format(snapshot.current_win_percentage) }}%</strong>
                    de chances pour les blancs.
                  </p>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <p class="mb-0 text-secondary">
                Aucune prédiction n'a pu être générée pour ce PGN.
              </p>
              {% endif %}
            </div>

            <div class="card p-4 p-lg-5 mb-4">
              <h2 class="h5 mb-3">PGN analysé</h2>
              <pre class="mb-0" data-pgn-display>{{ pgn }}</pre>
            </div>

            <div class="card p-4 p-lg-5">
              <h2 class="h5 mb-3">Métriques du modèle</h2>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="p-3 border rounded-3 bg-light">
                    <div class="text-secondary text-uppercase small fw-semibold">Tokens entrants</div>
                    <div class="fs-4 fw-bold">{{ metrics.input_tokens }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="p-3 border rounded-3 bg-light">
                    <div class="text-secondary text-uppercase small fw-semibold">Tokens sortants</div>
                    <div class="fs-4 fw-bold">{{ metrics.output_tokens }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="p-3 border rounded-3 bg-light">
                    <div class="text-secondary text-uppercase small fw-semibold">Coût estimé</div>
                    <div class="fs-4 fw-bold">${{ '%.6f'|format(metrics.cost) }}</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card p-4 p-lg-5 mt-4">
              <h2 class="h5 mb-3">Aller plus loin</h2>
              <p class="mb-3 text-secondary">
                Pour adapter Oracle à vos scénarios (préparation, entraînement ou diffusion), inspirez-vous des recommandations de
                la documentation&nbsp;:
              </p>
              <ul class="mb-3">
                <li>
                  Ajustez les paramètres d'analyse dans <code>OracleConfig</code> pour modifier profondeur, temps ou Elo et coller
                  au format de partie que vous étudiez.
                </li>
                <li>
                  Expérimentez avec différents modèles Hugging Face en surchargeant les variables
                  <code>HUGGINGFACE_MODEL_ID</code> et <code>HUGGINGFACEHUB_API_TOKEN</code>.
                </li>
                <li>
                  Capitalisez sur les résultats en exportant de nouveaux PGN ou en les comparant avec vos bases de données pour
                  identifier des plans alternatifs.
                </li>
              </ul>
              <p class="mb-0 small text-secondary">
                Besoin d'un rappel sur la configuration complète&nbsp;? Retournez sur la page d'accueil pour consulter le guide
                détaillé ou ouvrez le README du projet.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-footer text-center small">
      <div class="container-xxl px-4 px-lg-5">
        <span>
          Besoin d'aide ? Consultez la documentation dans le README ou vérifiez les logs serveur pour plus de détails.
        </span>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script type="module" src="{{ url_for('static', path='oracle-board.js') }}"></script>
    <script type="module">
    const analyzedPgn = {{ (pgn or "")|tojson }};
    const pgnDisplay = document.querySelector('[data-pgn-display]');

    const connectBoard = (board) => {
      if (!board) {
        return;
      }

      if (analyzedPgn) {
        board.loadPgn(analyzedPgn);
      }

      board.onMove(() => {
        if (pgnDisplay) {
          pgnDisplay.textContent = board.getPgn();
        }
      });

      board.onUpdate(({ pgn }) => {
        if (pgnDisplay) {
          pgnDisplay.textContent = pgn;
        }
      });
    };

    document.addEventListener(
      'oracle-board:ready',
      (event) => {
        connectBoard(event.detail);
      },
      { once: true },
    );

    if (window.oracleBoard) {
      connectBoard(window.oracleBoard);
    }
    </script>
  </body>
</html>
