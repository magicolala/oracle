<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Oracle Analyzer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', path='github-dark.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='oracle-board.css') }}" />
  </head>
  <body class="app-shell">
    {% set current_mode = active_mode or 'analyze' %}
    {% set analysis_modes = ['analyze', 'prediction'] %}
    {% set is_analyze_mode = current_mode == 'analyze' %}
    {% set is_prediction_mode = current_mode == 'prediction' %}
    {% set is_play_mode = current_mode == 'play' %}
    <!-- Initial Configuration Modal -->
    <div class="modal fade" id="initialConfigModal" tabindex="-1" aria-labelledby="initialConfigModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="initialConfigModalLabel">Configurez votre partie</h5>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <div class="btn-group" role="group" aria-label="Mode d'utilisation">
                <input
                  type="radio"
                  class="btn-check"
                  name="oracle-mode"
                  id="mode-analyze"
                  value="analyze"
                  data-mode-input
                  {% if is_analyze_mode %}checked{% endif %}
                />
                <label class="btn btn-outline-primary" for="mode-analyze">Analyse</label>
                <input
                  type="radio"
                  class="btn-check"
                  name="oracle-mode"
                  id="mode-prediction"
                  value="prediction"
                  data-mode-input
                  {% if is_prediction_mode %}checked{% endif %}
                />
                <label class="btn btn-outline-primary" for="mode-prediction">Prédictions</label>
                <input
                  type="radio"
                  class="btn-check"
                  name="oracle-mode"
                  id="mode-play"
                  value="play"
                  data-mode-input
                  {% if is_play_mode %}checked{% endif %}
                />
                <label class="btn btn-outline-primary" for="mode-play">Jouer contre l'ordinateur</label>
              </div>
            </div>
            <div data-mode-panel="analyze" {% if not is_analyze_mode %}hidden{% endif %}>
              <div class="col-12 col-md-6">
                <label for="modal-analysis-level" class="form-label fw-semibold">Niveau (optionnel)</label>
                <select class="form-select" id="modal-analysis-level" name="level">
                  <option value="" {% if not selected_level %}selected{% endif %}>
                    Utiliser les Elo du PGN
                  </option>
                  <option value="1000">Elo 1000</option>
                  <option value="1500">Elo 1500</option>
                  <option value="2000">Elo 2000</option>
                </select>
                <div class="form-text">
                  Choisissez un niveau cible pour ignorer les Elo du PGN et appliquer la cadence correspondante.
                </div>
              </div>
            </div>
            <div data-mode-panel="prediction" {% if not is_prediction_mode %}hidden{% endif %}>
              <div class="col-12 col-md-8">
                <p class="mb-2">
                  Le mode <strong>Prédictions</strong> vous permet d'obtenir rapidement les coups les plus probables
                  à partir d'un PGN ou du plateau interactif.
                </p>
                <p class="text-secondary mb-0">
                  Sélectionnez éventuellement un niveau cible pour adapter la cadence puis lancez la génération.
                </p>
              </div>
            </div>
            <div data-mode-panel="play" {% if not is_play_mode %}hidden{% endif %}>
              <div class="col-12 col-md-6">
                <label for="modal-play-level" class="form-label fw-semibold">Niveau de l'adversaire</label>
                <select class="form-select" id="modal-play-level" data-game-level>
                  <option value="" {% if not selected_level %}selected{% endif %}>
                    Recommandé automatiquement
                  </option>
                  <option value="1000">Elo 1000</option>
                  <option value="1500">Elo 1500</option>
                  <option value="2000">Elo 2000</option>
                </select>
                <div class="form-text">
                  Ajustez la difficulté ou laissez Oracle choisir un niveau adapté en fonction de la position.
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Commencer</button>
          </div>
        </div>
      </div>
    </div>
    <nav class="app-nav navbar navbar-dark">
      <div class="container-xxl">
        <a class="navbar-brand" href="/">Oracle Analyzer</a>
      </div>
    </nav>
    <main class="app-main">
      <div class="container-xxl">
        <div class="row g-4 justify-content-center">
          <div class="col-12 col-xl-10 col-xxl-9">
            {% if error %}
            <div class="alert alert-danger" role="alert">
              <h4 class="alert-heading">{{ error.title }}</h4>
              <p class="mb-2">{{ error.detail }}</p>
              {% if error.hint %}
              <hr />
              <p class="mb-0">{{ error.hint }}</p>
              {% endif %}
            </div>
            {% endif %}
            <div
              class="card p-4 p-lg-5"
              data-app-root
              data-active-mode="{{ current_mode }}"
              data-game-new-endpoint="/play/new"
              data-game-move-endpoint="/play/move"
              data-game-resign-endpoint="/play/resign"
            >
              <div class="row g-5 align-items-start">
                <div class="col-12 col-lg-6">
                  <div class="board-panel h-100">
                    <p class="board-panel__header mb-1">Plateau interactif</p>
                    <div id="oracle-board"></div>
                    <p class="board-panel__hint mb-0">
                      Selon le mode sélectionné, le plateau se synchronise avec votre PGN ou envoie vos coups à l'ordinateur.
                    </p>
                  </div>
                </div>
                  <div class="col-12 col-lg-6 d-flex flex-column gap-4" hidden id="controls-column">
                    <div data-mode-panel="analyze" class="mode-intro" {% if not is_analyze_mode %}hidden{% endif %}>
                      <h1 class="h3 mb-3">Analyser un PGN</h1>
                      <p class="text-secondary mb-4">
                        Collez la partie jusqu'au coup à étudier puis lancez une analyse complète pour découvrir les
                        séquences les plus probables.
                      </p>
                    </div>
                    <div data-mode-panel="prediction" class="mode-intro" {% if not is_prediction_mode %}hidden{% endif %}>
                      <h1 class="h3 mb-3">Mode Prédictions</h1>
                      <p class="text-secondary mb-4">
                        Utilisez le plateau ou un PGN pour générer instantanément les prochains coups suggérés tout en
                        conservant l'historique dans le tableau des résultats.
                      </p>
                    </div>
                    <form
                      method="post"
                      action="/analyze"
                      class="row g-3"
                      data-mode-panel="analyze,prediction"
                      {% if current_mode not in analysis_modes %}hidden{% endif %}
                    >
                      <input
                        type="hidden"
                        name="mode" value="{{ analysis_form_mode or 'analyze' }}"
                        data-analysis-mode-input
                      />
                      <div class="col-12">
                        <div class="form-label-group mb-2">
                          <label for="pgn" class="form-label fw-semibold mb-0">PGN</label>
                          <div class="board-actions">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-load-pgn>
                              Synchroniser le plateau
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" data-reset-board>
                              Réinitialiser
                            </button>
                          </div>
                        </div>
                        <textarea class="form-control" id="pgn" name="pgn" required>{{ pgn or "" }}</textarea>
                      </div>
                      <div class="col-12 col-md-6">
                        <label for="analysis-level" class="form-label fw-semibold">Niveau (optionnel)</label>
                        <select class="form-select" id="analysis-level" name="level">
                          <option value="" {% if not selected_level %}selected{% endif %}>
                            Utiliser les Elo du PGN
                          </option>
                          {% for option in levels or [] %}
                          <option value="{{ option.value }}" {% if selected_level == option.value %}selected{% endif %}>
                            {{ option.label }}
                          </option>
                          {% endfor %}
                        </select>
                        <div class="form-text">
                          Choisissez un niveau cible pour ignorer les Elo du PGN et appliquer la cadence correspondante.
                        </div>
                      </div>
                      <div class="col-12 d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">
                          <span class="me-2" aria-hidden="true">♟️</span>
                          <span data-mode-panel="analyze" {% if not is_analyze_mode %}hidden{% endif %}>Analyser</span>
                          <span data-mode-panel="prediction" {% if not is_prediction_mode %}hidden{% endif %}>
                            Lancer la prédiction
                          </span>
                        </button>
                      </div>
                    </form>
                    <div data-mode-panel="play" {% if not is_play_mode %}hidden{% endif %}>
                      <h1 class="h3 mb-3">Jouer contre l'ordinateur</h1>
                      <p class="text-secondary mb-4">
                        Choisissez la force adverse, démarrez une nouvelle partie puis jouez vos coups directement sur le plateau.
                        L'ordinateur répondra automatiquement.
                      </p>
                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <label for="play-level" class="form-label fw-semibold">Niveau de l'adversaire</label>
                          <select class="form-select" id="play-level" data-game-level>
                            <option value="" {% if not selected_level %}selected{% endif %}>
                              Recommandé automatiquement
                            </option>
                            {% for option in levels or [] %}
                            <option value="{{ option.value }}" {% if selected_level == option.value %}selected{% endif %}>
                              {{ option.label }}
                            </option>
                            {% endfor %}
                          </select>
                          <div class="form-text">
                            Ajustez la difficulté ou laissez Oracle choisir un niveau adapté en fonction de la position.
                          </div>
                        </div>
                        <div class="col-12 d-flex flex-wrap gap-2">
                          <button type="button" class="btn btn-primary" data-game-new>
                            <span class="me-2" aria-hidden="true">▶️</span>
                            Nouvelle partie
                          </button>
                          <button type="button" class="btn btn-outline-danger" data-game-resign disabled>
                            <span class="me-2" aria-hidden="true">🏳️</span>
                            Abandon
                          </button>
                        </div>
                        <div class="col-12">
                          <div class="alert alert-info mt-2" data-game-status hidden role="alert"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            <div class="card p-4 p-lg-5 mt-4" id="guide">
              <h2 class="h5 mb-3">Profiter pleinement d'Oracle</h2>
              <p class="text-secondary">
                Ce guide reprend les principales étapes de la documentation officielle pour préparer votre environnement,
                lancer l'interface web et interpréter les prédictions fournies par Oracle.
              </p>
              <div class="guide-section pb-3">
                <h3 class="h6 text-uppercase text-secondary fw-semibold">1. Préparer l'environnement</h3>
                <p class="mb-2">
                  Oracle combine le moteur Stockfish et un modèle hébergé sur Hugging Face. Avant de démarrer le serveur,
                  vérifiez les éléments suivants&nbsp;:
                </p>
                <ul class="mb-0">
                  <li>
                    Installez Stockfish localement et exportez son chemin absolu dans la variable d'environnement
                    <code>STOCKFISH_PATH</code>.
                  </li>
                  <li>
                    (Optionnel) Choisissez un modèle Hugging Face via <code>HUGGINGFACE_MODEL_ID</code> et renseignez
                    <code>HUGGINGFACEHUB_API_TOKEN</code> si l'endpoint nécessite une authentification.
                  </li>
                  <li>
                    Les paramètres par défaut (profondeur, temps, Elo, cadence) sont définis dans
                    <code>OracleConfig</code> et peuvent être ajustés pour coller à votre usage (blitz, classique, etc.).
                  </li>
                </ul>
              </div>
              <div class="guide-section pb-3">
                <h3 class="h6 text-uppercase text-secondary fw-semibold">2. Démarrer le serveur web</h3>
                <p>
                  Une fois les variables configurées, lancez l'application FastAPI avec Uvicorn. Le serveur se met en écoute par
                  défaut sur <code>http://127.0.0.1:8000/</code>&nbsp;:
                </p>
                <pre class="code-block">uvicorn src.oracle.web.app:app --reload</pre>
                <p class="mb-0 mt-2">
                  Le mode <em>reload</em> recharge automatiquement le serveur lorsque vous modifiez le code pendant vos tests.
                </p>
              </div>
              <div class="guide-section pb-3">
                <h3 class="h6 text-uppercase text-secondary fw-semibold">3. Préparer un PGN à analyser</h3>
                <p class="mb-2">
                  Oracle accepte un PGN complet jusqu'au coup que vous souhaitez prédire. Incluez les balises si vous les avez et
                  assurez-use that the notation SAN is correct.
                </p>
                <p class="text-secondary small mb-2">Exemple minimal&nbsp;:</p>
                <pre class="code-block">[Event "Exemple"]
[Site "Local"]
[White "Joueur A"]
[Black "Joueur B"]
[Result "*"]

1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 *</pre>
                <p class="mb-0">
                  Collez le PGN ci-dessus (ou le vôtre) dans le formulaire, puis cliquez sur <strong>Analyser</strong> pour que
                  l'application calcule les coups probables suivants.
                </p>
              </div>
              <div class="guide-section pb-3">
                <h3 class="h6 text-uppercase text-secondary fw-semibold">4. Lire et exploiter les résultats</h3>
                <p class="mb-2">
                  La page de résultats présente&nbsp;:
                </p>
                <ul class="mb-0">
                  <li>Le pourcentage de gain estimé pour les blancs dans la position actuelle.</li>
                  <li>Un classement des coups probables avec leur probabilité et l'évaluation associée.</li>
                  <li>Les métriques du modèle (tokens utilisés, coût estimé) pour suivre la consommation de l'API Hugging Face.</li>
                  <li>Le PGN analysé pour vérification rapide et partage.</li>
                </ul>
              </div>
              <div class="guide-section pb-1">
                <h3 class="h6 text-uppercase text-secondary fw-semibold">5. Dépannage rapide</h3>
                <ul class="mb-0">
                  <li>Erreur sur <code>STOCKFISH_PATH</code>&nbsp;: vérifiez que le chemin pointe bien vers un binaire exécutable.</li>
                  <li>PGN invalide&nbsp;: corrigez la notation SAN ou la numérotation des coups avant de relancer l'analyse.</li>
                  <li>
                    Temps de réponse ou coût élevés&nbsp;: sélectionnez un modèle Hugging Face plus léger ou ajustez les paramètres
                    d'analyse dans <code>OracleConfig</code>.
                  </li>
                </ul>
              </div>
              <p class="mt-3 mb-0 small text-secondary">
                Retrouvez davantage de détails (modes CLI, configuration avancée, exemples) dans le fichier
                <a
                  href="https://github.com/yoshachess/oracle/blob/main/README.md"
                  class="link-secondary"
                  target="_blank"
                  rel="noopener"
                  >README</a
                >
                du projet.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-footer text-center small">
      <div class="container-xxl">
        <span>
          Besoin d'aide ? Consultez la documentation dans le README ou vérifiez les logs serveur pour plus de détails.
        </span>
      </div>
    </footer>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script type="module" src="{{ url_for('static', path='oracle-board.js') }}"></script>
    <script type="module">
      document.addEventListener('DOMContentLoaded', () => {
        const bootstrap = window.bootstrap;
        const modalElement = document.getElementById('initialConfigModal');
        const initialConfigModal =
          bootstrap && bootstrap.Modal
            ? new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
              })
            : null;

        if (!initialConfigModal) {
          console.warn(
            "Bootstrap JavaScript n'a pas pu être chargé. La configuration initiale ne s'ouvrira pas automatiquement.",
          );
        } else {
          initialConfigModal.show();
        }

        const appRoot = document.querySelector('[data-app-root]');
        const modalModePanels = {
          analyze: modalElement?.querySelector('[data-mode-panel="analyze"]') ?? null,
          prediction: modalElement?.querySelector('[data-mode-panel="prediction"]') ?? null,
          play: modalElement?.querySelector('[data-mode-panel="play"]') ?? null,
        };
        const modeInputs = document.querySelectorAll('input[name="oracle-mode"]');
        const analysisLevelSelect = document.getElementById('modal-analysis-level');
        const playLevelSelect = document.getElementById('modal-play-level');
        const analysisFormSelect = document.getElementById('analysis-level');
        const playFormSelect = document.getElementById('play-level');
        const commenceButton = document.querySelector('#initialConfigModal .btn-primary');
        const controlsColumn = document.getElementById('controls-column'); // Get the controls column

        // Get references to layout elements
        const navElement = document.querySelector('.app-nav');
        const footerElement = document.querySelector('.app-footer');
        const mainElement = document.querySelector('.app-main');
        const oracleBoard = document.getElementById('oracle-board');
        const boardPanel = document.querySelector('.board-panel');


        // Function to calculate and set chessboard size
        const setChessboardSize = () => {
          const navHeight = navElement ? navElement.offsetHeight : 0;
          const footerHeight = footerElement ? footerElement.offsetHeight : 0;
          const mainPadding = 32; // Approximate padding from .card p-4 p-lg-5 and row g-4
          const availableHeight = window.innerHeight - navHeight - footerHeight - (mainPadding * 2); // Adjust for main content padding/margins
          const containerWidth = boardPanel ? boardPanel.clientWidth : mainElement.offsetWidth;

          if (!containerWidth) {
            return;
          }

          // The chessboard is a square, so its size is limited by the minimum of available height and width
          const baseSize = Math.min(availableHeight, containerWidth);
          const minimumComfortSize = Math.min(containerWidth, 320);
          const boardSize = Math.max(baseSize, minimumComfortSize);

          if (oracleBoard && boardPanel) {
            oracleBoard.style.width = `${boardSize}px`;
            oracleBoard.style.height = `${boardSize}px`;
            const panelStyles = window.getComputedStyle(boardPanel);
            const horizontalPadding =
              parseFloat(panelStyles.paddingLeft || '0') + parseFloat(panelStyles.paddingRight || '0');
            const horizontalBorder =
              parseFloat(panelStyles.borderLeftWidth || '0') + parseFloat(panelStyles.borderRightWidth || '0');
            const panelWidth = boardSize + horizontalPadding + horizontalBorder;
            boardPanel.style.maxWidth = `${panelWidth}px`;
            boardPanel.style.marginInline = 'auto';
          }
        };

        // Function to update UI based on selected mode
        const analysisModeSet = new Set(['analyze', 'prediction']);

        const updateModeUI = (mode) => {
          (Object.entries(modalModePanels) || []).forEach(([panelMode, panelElement]) => {
            if (!panelElement) {
              return;
            }
            panelElement.hidden = panelMode !== mode;
          });
          if (controlsColumn) {
            controlsColumn.hidden = false;
          }
        };

        // Event listener for mode selection in modal
        modeInputs.forEach(input => {
          input.addEventListener('change', (event) => {
            updateModeUI(event.target.value);
          });
        });

        // Initial UI update based on default checked mode
        const initialMode = document.querySelector('input[name="oracle-mode"]:checked').value;
        updateModeUI(initialMode);


        commenceButton.addEventListener('click', () => {
          const selectedMode = document.querySelector('input[name="oracle-mode"]:checked').value;
          const isAnalysisMode = analysisModeSet.has(selectedMode);
          const selectedLevel = isAnalysisMode
            ? analysisLevelSelect?.value ?? ''
            : playLevelSelect?.value ?? '';

          appRoot.dataset.activeMode = selectedMode;
          updateModeUI(selectedMode);
          if (isAnalysisMode && analysisFormSelect) {
            analysisFormSelect.value = selectedLevel;
          }
          if (selectedMode === 'play' && playFormSelect) {
            playFormSelect.value = selectedLevel;
          }
          // You might want to pass the selectedLevel to the board or other parts of the app here
          // For now, we'll just update the activeMode.

          if (initialConfigModal) {
            initialConfigModal.hide();
          } else if (modalElement) {
            modalElement.classList.add('d-none');
          }
          setChessboardSize(); // Set chessboard size after modal is dismissed
        });

        // Set initial size and add resize listener
        setChessboardSize();
        window.addEventListener('resize', setChessboardSize);
      });
    </script>
  </body>
</html>